<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Admin</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <a class="navbar-brand text-navy" href="index.html">
                    <i class="bi bi-pc-display"></i> <span>LAB ITAMA</span>
                </a>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="admin.html"><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_proyektor.html"><i class="fa-solid fa-video"></i> <span>Input Proyektor</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_laptop.html"><i class="fa-solid fa-laptop"></i> <span>Input Laptop</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_mahasiswas.html"><i class="fa-solid fa-user-graduate"></i> <span>Input Mahasiswa</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="riwayat.html"><i class="fa-solid fa-clock-rotate-left"></i> <span>Riwayat</span></a>
                </li>
            </ul>
        </nav>
        
        <!-- Offcanvas Sidebar for Mobile -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
            <div class="offcanvas-header">
                 <h5 class="offcanvas-title" id="offcanvasSidebarLabel"><a class="navbar-brand text-navy" href="index.html"><i class="bi bi-pc-display"></i> LAB ITAMA</a></h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="admin.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_proyektor.html"><i class="fa-solid fa-video"></i> Input Proyektor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_laptop.html"><i class="fa-solid fa-laptop"></i> Input Laptop</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_mahasiswas.html"><i class="fa-solid fa-user-graduate"></i> Input Mahasiswa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="riwayat.html"><i class="fa-solid fa-clock-rotate-left"></i> Riwayat</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Top Navbar with Toggles -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
                <div class="container-fluid">
                    <!-- Mobile Toggle (Hamburger) -->
                    <button class="btn btn-navy d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    
                    <!-- Desktop Toggle (Chevron) -->
                    <button id="sidebar-toggle" class="btn btn-navy d-none d-lg-inline-block">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>
                    
                    <span class="navbar-brand mb-0 h1 mx-auto">Admin Dashboard</span>
                </div>
            </nav>

            <h1 class="mb-4 d-none d-lg-block">Dashboard Admin</h1>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <input type="text" id="searchInput" class="form-control" placeholder="Cari ID Pengguna...">
                        </div>
                        <div class="col-md-4">
                            <select id="statusFilter" class="form-select">
                                <option value="">Semua Status</option>
                                <option value="active">Aktif</option>
                                <option value="pending_extension">Menunggu Perpanjangan</option>
                                <option value="returned">Dikembalikan</option>
                                <option value="reloaned">Diperpanjang (Lama)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="h4">Peminjaman Proyektor</h2>
            <div id="projector-loans-container" class="table-responsive"></div>

            <h2 class="h4 mt-4">Peminjaman Laptop</h2>
            <div id="laptop-loans-container" class="table-responsive"></div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar Toggle Script
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const sidebar = document.getElementById('sidebar');
            const toggleIcon = sidebarToggle.querySelector('i');

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('collapsed');
                // Change icon based on state
                if (sidebar.classList.contains('collapsed')) {
                    toggleIcon.classList.remove('fa-chevron-left');
                    toggleIcon.classList.add('fa-chevron-right');
                } else {
                    toggleIcon.classList.remove('fa-chevron-right');
                    toggleIcon.classList.add('fa-chevron-left');
                }
            });


            // Original Dashboard Data Script
            let allLoans = [];

            // Event delegation for confirm buttons
            document.addEventListener('click', async function(event) {
                if (event.target.classList.contains('confirm-reloan-btn')) {
                    const loanId = event.target.dataset.loanId;
                    await confirmReloan(loanId);
                }
            });

            async function confirmReloan(loanId) {
                try {
                    const response = await fetch(`/api/loans/${loanId}/confirm-reloan`, { method: 'POST' });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message);
                    alert('Peminjaman berhasil diperpanjang.');
                    fetchAndRenderDashboard(); // Re-render after action
                } catch (error) {
                    console.error('Error confirming reloan:', error);
                    alert(error.message || 'Gagal mengkonfirmasi perpanjangan.');
                }
            }

            const projectorContainer = document.getElementById('projector-loans-container');
            const laptopContainer = document.getElementById('laptop-loans-container');
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            
            searchInput.addEventListener('input', renderFilteredDashboard);
            statusFilter.addEventListener('change', renderFilteredDashboard);

            const renderTable = (container, loans, deviceType) => {
                const table = document.createElement('table');
                table.className = 'table table-bordered table-striped table-hover';
                table.innerHTML = `
                    <thead class="table-dark bg-navy">
                        <tr>
                            <th>ID Peminjam</th>
                            <th>Nama Peminjam</th>
                            <th>ID Perangkat</th>
                            <th>Nama Pemilik Perangkat</th>
                            <th>Waktu Pinjam</th>
                            <th>Waktu Kembali</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${loans.length === 0 ? `
                            <tr>
                                <td colspan="8" class="text-center">Tidak ada data peminjaman ${deviceType} yang cocok.</td>
                            </tr>
                        ` : loans.map(loan => `
                            <tr>
                                <td>${loan.studentId}</td>
                                <td>${loan.borrowerName || 'N/A'}</td>
                                <td>${loan.deviceId || ''}</td>
                                <td>${loan.deviceOwnerName || 'N/A'}</td>
                                <td>${new Date(loan.borrowedAt).toLocaleString()}</td>
                                <td>${loan.returnedAt ? new Date(loan.returnedAt).toLocaleString() : 'Belum Dikembalikan'}</td>
                                <td><span class="badge bg-secondary">${loan.status}</span></td>
                                <td>
                                    ${loan.status === 'pending_extension' ? `<button class="btn btn-success btn-sm confirm-reloan-btn" data-loan-id="${loan.id}">Konfirmasi</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                `;
                container.innerHTML = '';
                container.appendChild(table);
            };

            function renderFilteredDashboard() {
                const searchTerm = searchInput.value.toLowerCase();
                const status = statusFilter.value;
                const filteredLoans = allLoans.filter(loan =>
                    (!searchTerm || loan.studentId.toLowerCase().includes(searchTerm)) &&
                    (!status || loan.status === status)
                );
                renderTable(projectorContainer, filteredLoans.filter(l => l.device === 'Proyektor'), 'Proyektor');
                renderTable(laptopContainer, filteredLoans.filter(l => l.device === 'Laptop'), 'Laptop');
            }

            function fetchAndRenderDashboard() {
                fetch('/api/loans')
                    .then(response => response.json())
                    .then(loans => {
                        allLoans = loans.sort((a, b) => new Date(b.borrowedAt) - new Date(a.borrowedAt));
                        renderFilteredDashboard();
                    })
                    .catch(error => {
                        console.error('Error fetching loans:', error);
                        projectorContainer.innerHTML = '<p class="text-danger">Gagal memuat data pinjaman.</p>';
                        laptopContainer.innerHTML = '<p class="text-danger">Gagal memuat data pinjaman.</p>';
                    });
            };

            // Initial fetch
            fetchAndRenderDashboard();

            // SSE for real-time updates
            const eventSource = new EventSource('/api/events');
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'loan_updated') {
                    console.log('Loan data updated, re-fetching dashboard...');
                    fetchAndRenderDashboard();
                }
            };
            eventSource.onerror = () => console.error('EventSource failed.');
        });
    </script>
</body>
</html>