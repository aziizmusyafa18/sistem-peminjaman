<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Riwayat Peminjaman</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <a class="navbar-brand text-navy" href="index.html">
                    <i class="bi bi-pc-display"></i> <span>LAB ITAMA</span>
                </a>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="admin.html"><i class="fa-solid fa-chart-line"></i> <span>Dashboard</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_proyektor.html"><i class="fa-solid fa-video"></i> <span>Input Proyektor</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_laptop.html"><i class="fa-solid fa-laptop"></i> <span>Input Laptop</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_mahasiswas.html"><i class="fa-solid fa-user-graduate"></i> <span>Input Mahasiswa</span></a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="riwayat.html"><i class="fa-solid fa-clock-rotate-left"></i> <span>Riwayat</span></a>
                </li>
            </ul>
        </nav>

        <!-- Offcanvas Sidebar for Mobile -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
            <div class="offcanvas-header">
                 <h5 class="offcanvas-title" id="offcanvasSidebarLabel"><a class="navbar-brand text-navy" href="index.html"><i class="bi bi-pc-display"></i> LAB ITAMA</a></h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_proyektor.html"><i class="fa-solid fa-video"></i> Input Proyektor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_laptop.html"><i class="fa-solid fa-laptop"></i> Input Laptop</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_mahasiswas.html"><i class="fa-solid fa-user-graduate"></i> Input Mahasiswa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="riwayat.html"><i class="fa-solid fa-clock-rotate-left"></i> Riwayat</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Top Navbar with Toggles -->
            <nav class="navbar navbar-expand-lg navbar-light bg-light mb-3">
                <div class="container-fluid">
                    <!-- Mobile Toggle (Hamburger) -->
                    <button class="btn btn-navy d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                        <i class="fa-solid fa-bars"></i>
                    </button>

                    <!-- Desktop Toggle (Chevron) -->
                    <button id="sidebar-toggle" class="btn btn-navy d-none d-lg-inline-block">
                        <i class="fa-solid fa-chevron-left"></i>
                    </button>

                    <span class="navbar-brand mb-0 h1 mx-auto">Riwayat Peminjaman</span>
                </div>
            </nav>

            <h1 class="mb-4 d-none d-lg-block">Riwayat Peminjaman</h1>

            <!-- Filter Section -->
            <div class="card mb-4">
                <div class="card-header bg-navy">
                    <i class="fa-solid fa-filter"></i> Filter Tanggal
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="startDate" class="form-label">Tanggal Mulai</label>
                            <input type="date" id="startDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label for="endDate" class="form-label">Tanggal Akhir</label>
                            <input type="date" id="endDate" class="form-control">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label d-block">&nbsp;</label>
                            <button id="filterBtn" class="btn btn-navy me-2">
                                <i class="fa-solid fa-search"></i> Filter
                            </button>
                            <button id="resetBtn" class="btn btn-secondary">
                                <i class="fa-solid fa-rotate-right"></i> Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="row mb-4" id="statsCards">
                <!-- Will be populated by JavaScript -->
            </div>

            <!-- Rekap Per Hari -->
            <div class="card mb-4">
                <div class="card-header bg-navy">
                    <i class="fa-solid fa-chart-bar"></i> Rekap Peminjaman Per Hari
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="bg-navy">
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Total Peminjaman</th>
                                    <th>Laptop</th>
                                    <th>Proyektor</th>
                                    <th>Dikembalikan</th>
                                    <th>Aktif</th>
                                </tr>
                            </thead>
                            <tbody id="statsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Detail Peminjaman -->
            <div class="card">
                <div class="card-header bg-navy">
                    <i class="fa-solid fa-list"></i> Detail Riwayat Peminjaman
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="bg-navy">
                                <tr>
                                    <th>Tanggal</th>
                                    <th>ID Mahasiswa</th>
                                    <th>Nama Peminjam</th>
                                    <th>Perangkat</th>
                                    <th>ID Perangkat</th>
                                    <th>Pemilik Perangkat</th>
                                    <th>Waktu Pinjam</th>
                                    <th>Waktu Kembali</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">Memuat data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Sidebar toggle functionality
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');
        const toggleIcon = sidebarToggle.querySelector('i');

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            if (sidebar.classList.contains('collapsed')) {
                toggleIcon.classList.remove('fa-chevron-left');
                toggleIcon.classList.add('fa-chevron-right');
            } else {
                toggleIcon.classList.remove('fa-chevron-right');
                toggleIcon.classList.add('fa-chevron-left');
            }
        });

        // Filter functionality
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const filterBtn = document.getElementById('filterBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statsTableBody = document.getElementById('statsTableBody');
        const historyTableBody = document.getElementById('historyTableBody');
        const statsCards = document.getElementById('statsCards');

        // Set default dates (empty to show all data)
        // User can filter manually if needed
        const today = new Date();

        // Leave empty to show all data by default
        endDateInput.value = '';
        startDateInput.value = '';

        async function fetchHistory() {
            try {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                let url = '/api/history';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const data = await response.json();
                console.log('History data received:', data);
                console.log('Total records:', data.length);
                displayHistory(data);
            } catch (err) {
                console.error('Error fetching history:', err);
                historyTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Gagal memuat data riwayat</td></tr>';
            }
        }

        async function fetchStats() {
            try {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;

                let url = '/api/history/stats';
                const params = new URLSearchParams();
                if (startDate) params.append('startDate', startDate);
                if (endDate) params.append('endDate', endDate);
                if (params.toString()) url += '?' + params.toString();

                const response = await fetch(url);
                const data = await response.json();
                console.log('Stats data received:', data);
                console.log('Total days:', data.length);
                displayStats(data);
                displayStatsCards(data);
            } catch (err) {
                console.error('Error fetching stats:', err);
                statsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Gagal memuat data statistik</td></tr>';
            }
        }

        function displayHistory(data) {
            if (data.length === 0) {
                historyTableBody.innerHTML = '<tr><td colspan="9" class="text-center">Tidak ada data</td></tr>';
                return;
            }

            historyTableBody.innerHTML = data.map(item => {
                const tanggal = new Date(item.tanggalPinjam).toLocaleDateString('id-ID');
                const waktuPinjam = new Date(item.borrowedAt).toLocaleString('id-ID');
                const waktuKembali = item.returnedAt ? new Date(item.returnedAt).toLocaleString('id-ID') : '-';

                let statusBadge = '';
                if (item.status === 'active') {
                    statusBadge = '<span class="badge bg-success">Aktif</span>';
                } else if (item.status === 'returned') {
                    statusBadge = '<span class="badge bg-secondary">Dikembalikan</span>';
                } else if (item.status === 'pending_extension') {
                    statusBadge = '<span class="badge bg-warning">Menunggu</span>';
                }

                return `
                    <tr>
                        <td>${tanggal}</td>
                        <td>${item.studentId}</td>
                        <td>${item.borrowerName}</td>
                        <td><span class="badge ${item.device === 'Laptop' ? 'bg-primary' : 'bg-info'}">${item.device}</span></td>
                        <td>${item.deviceId}</td>
                        <td>${item.deviceOwnerName || '-'}</td>
                        <td>${waktuPinjam}</td>
                        <td>${waktuKembali}</td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayStats(data) {
            if (data.length === 0) {
                statsTableBody.innerHTML = '<tr><td colspan="6" class="text-center">Tidak ada data</td></tr>';
                return;
            }

            statsTableBody.innerHTML = data.map(item => {
                const tanggal = new Date(item.tanggal).toLocaleDateString('id-ID', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                return `
                    <tr>
                        <td><strong>${tanggal}</strong></td>
                        <td><span class="badge bg-navy">${item.totalPeminjaman}</span></td>
                        <td><span class="badge bg-primary">${item.totalLaptop}</span></td>
                        <td><span class="badge bg-info">${item.totalProyektor}</span></td>
                        <td><span class="badge bg-secondary">${item.totalDikembalikan}</span></td>
                        <td><span class="badge bg-success">${item.totalAktif}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function displayStatsCards(data) {
            if (data.length === 0) {
                statsCards.innerHTML = '<div class="col-12"><p class="text-center">Tidak ada data statistik</p></div>';
                return;
            }

            // Calculate totals
            const totals = data.reduce((acc, item) => {
                acc.totalPeminjaman += parseInt(item.totalPeminjaman);
                acc.totalLaptop += parseInt(item.totalLaptop);
                acc.totalProyektor += parseInt(item.totalProyektor);
                acc.totalDikembalikan += parseInt(item.totalDikembalikan);
                acc.totalAktif += parseInt(item.totalAktif);
                return acc;
            }, {
                totalPeminjaman: 0,
                totalLaptop: 0,
                totalProyektor: 0,
                totalDikembalikan: 0,
                totalAktif: 0
            });

            statsCards.innerHTML = `
                <div class="col-md-4 col-lg-2 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fa-solid fa-list fa-2x text-navy mb-2"></i>
                            <h5 class="card-title">${totals.totalPeminjaman}</h5>
                            <p class="card-text">Total Peminjaman</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fa-solid fa-laptop fa-2x text-primary mb-2"></i>
                            <h5 class="card-title">${totals.totalLaptop}</h5>
                            <p class="card-text">Laptop</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fa-solid fa-video fa-2x text-info mb-2"></i>
                            <h5 class="card-title">${totals.totalProyektor}</h5>
                            <p class="card-text">Proyektor</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fa-solid fa-check-circle fa-2x text-secondary mb-2"></i>
                            <h5 class="card-title">${totals.totalDikembalikan}</h5>
                            <p class="card-text">Dikembalikan</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fa-solid fa-clock fa-2x text-success mb-2"></i>
                            <h5 class="card-title">${totals.totalAktif}</h5>
                            <p class="card-text">Aktif</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 col-lg-2 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fa-solid fa-calendar-days fa-2x text-warning mb-2"></i>
                            <h5 class="card-title">${data.length}</h5>
                            <p class="card-text">Hari</p>
                        </div>
                    </div>
                </div>
            `;
        }

        filterBtn.addEventListener('click', () => {
            fetchHistory();
            fetchStats();
        });

        resetBtn.addEventListener('click', () => {
            // Reset to show all data (empty filter)
            endDateInput.value = '';
            startDateInput.value = '';

            fetchHistory();
            fetchStats();
        });

        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            fetchHistory();
            fetchStats();
        });
    </script>
</body>
</html>
