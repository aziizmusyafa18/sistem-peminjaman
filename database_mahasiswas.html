<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Data Mahasiswa</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar for Desktop -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <a class="navbar-brand text-navy" href="index.html"><i class="bi bi-pc-display"></i></i> LAB ITAMA</a>
            </div>
            <ul class="nav flex-column">
                <li class="nav-item">
                    <a class="nav-link" href="admin.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_proyektor.html"><i class="fa-solid fa-video"></i> Input Proyektor</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="database_laptop.html"><i class="fa-solid fa-laptop"></i> Input Laptop</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="database_mahasiswas.html"><i class="fa-solid fa-user-graduate"></i> Input Mahasiswa</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="riwayat.html"><i class="fa-solid fa-clock-rotate-left"></i> Riwayat</a>
                </li>
            </ul>
        </nav>
        
        <!-- Offcanvas Sidebar for Mobile -->
        <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar" aria-labelledby="offcanvasSidebarLabel">
            <div class="offcanvas-header">
                <h5 class="offcanvas-title" id="offcanvasSidebarLabel"><a class="navbar-brand text-navy" href="index.html"><i class="bi bi-pc-display"></i></i> LAB ITAMA</a></h5>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
            </div>
            <div class="offcanvas-body">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="admin.html"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_proyektor.html"><i class="fa-solid fa-video"></i> Input Proyektor</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="database_laptop.html"><i class="fa-solid fa-laptop"></i> Input Laptop</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="database_mahasiswas.html"><i class="fa-solid fa-user-graduate"></i> Input Mahasiswa</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="riwayat.html"><i class="fa-solid fa-clock-rotate-left"></i> Riwayat</a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Top Navbar for Mobile Toggle -->
            <nav class="navbar navbar-light bg-light d-lg-none mb-3">
                <div class="container-fluid">
                    <button class="btn btn-navy" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <span class="navbar-brand mb-0 h1">Input Mahasiswa</span>
                </div>
            </nav>

            <h1 class="mb-4 d-none d-lg-block">Manajemen Data Mahasiswa</h1>

            <div class="card">
                <div class="card-header">Formulir Mahasiswa</div>
                <div class="card-body">
                    <form id="mahasiswaForm">
                        <input type="hidden" id="mahasiswaId">
                        <div class="mb-3"><label for="id_mahasiswa" class="form-label">ID Mahasiswa</label><input type="text" class="form-control" id="id_mahasiswa" required></div>
                        <div class="mb-3"><label for="nama_mahasiswa" class="form-label">Nama Mahasiswa</label><input type="text" class="form-control" id="nama_mahasiswa" required></div>
                        <div class="mb-3"><label for="prodi" class="form-label">Prodi</label><input type="text" class="form-control" id="prodi" required></div>
                        <button type="submit" class="btn btn-navy">Tambah/Update</button>
                        <button type="button" id="cancelEdit" class="btn btn-secondary hidden">Batal Edit</button>
                    </form>
                </div>
            </div>

            <h2 class="mt-5">Daftar Mahasiswa</h2>
            <div class="table-responsive">
                <table id="mahasiswaTable" class="table table-striped table-hover">
                    <thead class="bg-navy">
                        <tr><th>ID</th><th>Nama</th><th>Prodi</th><th>Aksi</th></tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Elements ---
        const mahasiswaForm = document.getElementById('mahasiswaForm');
        const idMahasiswaInput = document.getElementById('id_mahasiswa');
        const namaMahasiswaInput = document.getElementById('nama_mahasiswa');
        const prodiInput = document.getElementById('prodi');
        const mahasiswaTableBody = document.querySelector('#mahasiswaTable tbody');
        const cancelEditButton = document.getElementById('cancelEdit');
        let editingMahasiswaId = null; // null if creating, holds ID if editing

        // --- Data Fetching and Display ---

        // Fetches all students from the API and triggers display
        async function fetchMahasiswas() {
            try {
                const response = await fetch('/api/mahasiswas');
                if (!response.ok) throw new Error('Gagal mengambil data dari server.');
                const mahasiswas = await response.json();
                displayMahasiswas(mahasiswas);
            } catch (error) {
                console.error('Error fetching mahasiswas:', error);
                mahasiswaTableBody.innerHTML = `<tr><td colspan="4" class="text-center text-danger">Gagal memuat data. Periksa konsol untuk detail.</td></tr>`;
            }
        }

        // Clears the table and displays the given list of students
        function displayMahasiswas(mahasiswas) {
            mahasiswaTableBody.innerHTML = '';
            if (!mahasiswas || mahasiswas.length === 0) {
                 mahasiswaTableBody.innerHTML = `<tr><td colspan="4" class="text-center">Belum ada data mahasiswa.</td></tr>`;
                 return;
            }
            mahasiswas.forEach(mahasiswa => {
                const row = mahasiswaTableBody.insertRow();
                // WARNING: Using JSON.stringify in an onclick is fragile. Assumes no conflicting characters in data.
                row.innerHTML = `
                    <td>${mahasiswa.id_mahasiswa}</td>
                    <td>${mahasiswa.nama_mahasiswa}</td>
                    <td>${mahasiswa.prodi}</td>
                    <td>
                        <button class="btn btn-navy btn-sm" onclick='editMahasiswa(${JSON.stringify(mahasiswa)})'>Edit</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteMahasiswa('${mahasiswa.id_mahasiswa}')">Hapus</button>
                    </td>`;
            });
        }

        // --- CRUD Functions ---

        // Populates the form for editing a student
        function editMahasiswa(mahasiswa) {
            editingMahasiswaId = mahasiswa.id_mahasiswa;
            idMahasiswaInput.value = mahasiswa.id_mahasiswa;
            idMahasiswaInput.readOnly = true; // Prevent editing the ID
            namaMahasiswaInput.value = mahasiswa.nama_mahasiswa;
            prodiInput.value = mahasiswa.prodi;
            cancelEditButton.style.display = 'inline-block'; // Show cancel button
            window.scrollTo(0, 0); // Scroll to top to see the form
        }

        // Deletes a student by ID
        async function deleteMahasiswa(id) {
            if (!confirm(`Anda yakin ingin menghapus mahasiswa dengan ID ${id}?`)) return;
            try {
                const response = await fetch(`/api/mahasiswas/${id}`, { method: 'DELETE' });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Gagal menghapus.');
                fetchMahasiswas(); // Refresh table on success
            } catch (error) {
                alert(`Gagal menghapus: ${error.message}`);
            }
        }
        
        // --- Event Listeners ---

        // Resets the form when "Batal Edit" is clicked
        cancelEditButton.addEventListener('click', () => {
            editingMahasiswaId = null;
            mahasiswaForm.reset();
            idMahasiswaInput.readOnly = false;
            cancelEditButton.style.display = 'none';
        });

        // Handles form submission for both creating (POST) and updating (PUT)
        mahasiswaForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const isEditing = editingMahasiswaId !== null;
            const url = isEditing ? `/api/mahasiswas/${editingMahasiswaId}` : '/api/mahasiswas';
            const method = isEditing ? 'PUT' : 'POST';

            const mahasiswaData = { 
                // For POST, id_mahasiswa is taken from the form. For PUT, it's ignored by the server but sent anyway.
                id_mahasiswa: idMahasiswaInput.value, 
                nama_mahasiswa: namaMahasiswaInput.value, 
                prodi: prodiInput.value 
            };

            try {
                const response = await fetch(url, { 
                    method: method, 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(mahasiswaData) 
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Terjadi kesalahan.');
                
                // Success, reset form and refresh table
                cancelEditButton.click(); 
                fetchMahasiswas();

            } catch (error) {
                alert(`Gagal menyimpan: ${error.message}`);
            }
        });

        // Initial data load when the page is ready
        document.addEventListener('DOMContentLoaded', fetchMahasiswas);
    </script>
</body>
</html>
